<script>
    /**
     * ê²½ë¡œ ì •ë³´ ìºì‹œ ê´€ë¦¬
     */
    const RouteCache = {
      CACHE_DURATION: 30 * 60 * 1000, // 30ë¶„

      /**
       * ìºì‹œ í‚¤ ìƒì„±
       */
      getCacheKey: function(originLat, originLng, destLat, destLng) {
        return `route_${originLat.toFixed(5)}_${originLng.toFixed(5)}_${destLat.toFixed(5)}_${destLng.toFixed(5)}`;
      },

      /**
       * ìºì‹œì—ì„œ ê²½ë¡œ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
       */
      get: function(originLat, originLng, destLat, destLng) {
        try {
          const key = this.getCacheKey(originLat, originLng, destLat, destLng);
          const cached = localStorage.getItem(key);

          if (!cached) {
            return null;
          }

          const data = JSON.parse(cached);
          const now = new Date().getTime();

          // ìºì‹œê°€ ë§Œë£Œë˜ì—ˆëŠ”ì§€ í™•ì¸
          if (now - data.timestamp > this.CACHE_DURATION) {
            localStorage.removeItem(key);
            return null;
          }

          console.log('âœ… ìºì‹œì—ì„œ ê²½ë¡œ ì •ë³´ ë¡œë“œ:', key);
          return data.routes;
        } catch (error) {
          console.error('ìºì‹œ ì½ê¸° ì‹¤íŒ¨:', error);
          return null;
        }
      },

      /**
       * ê²½ë¡œ ì •ë³´ ìºì‹±
       */
      set: function(originLat, originLng, destLat, destLng, routes) {
        try {
          const key = this.getCacheKey(originLat, originLng, destLat, destLng);
          const data = {
            timestamp: new Date().getTime(),
            routes: routes
          };

          localStorage.setItem(key, JSON.stringify(data));
          console.log('ğŸ’¾ ê²½ë¡œ ì •ë³´ ìºì‹œ ì €ì¥:', key);
        } catch (error) {
          console.error('ìºì‹œ ì €ì¥ ì‹¤íŒ¨:', error);
        }
      },

      /**
       * ëª¨ë“  ìºì‹œ ì‚­ì œ
       */
      clearAll: function() {
        try {
          const keys = Object.keys(localStorage);
          keys.forEach(key => {
            if (key.startsWith('route_')) {
              localStorage.removeItem(key);
            }
          });
          console.log('ğŸ—‘ï¸ ëª¨ë“  ê²½ë¡œ ìºì‹œ ì‚­ì œ');
        } catch (error) {
          console.error('ìºì‹œ ì‚­ì œ ì‹¤íŒ¨:', error);
        }
      }
    };

    /**
     * ì‚¬ìš©ì í˜ì´ì§€ ì• í”Œë¦¬ì¼€ì´ì…˜
     */
    const UserApp = {
      currentPosition: null,
      userId: null,
      userName: null,
      watchId: null,
      routeUpdateInterval: null,
      currentEvents: [],
      attendanceStatus: "pending",
      
      /**
       * ì´ˆê¸°í™”
       */
      init: function() {
        console.log('UserApp initializing...');
        
        const savedUserId = localStorage.getItem('attendanceUserId');
        const savedUserName = localStorage.getItem('attendanceUserName');
        
        if (savedUserId) {
          this.userId = savedUserId;
          this.userName = savedUserName;
          this.showMainScreen();
          this.startLocationTracking();
          this.loadEvents();
          
          // ìœ„ì¹˜ ì—…ë°ì´íŠ¸ (1ë¶„ë§ˆë‹¤)
          setInterval(() => this.updateLocation(), 60000);
          
          // ì´ë²¤íŠ¸ ìƒˆë¡œê³ ì¹¨ (5ë¶„ë§ˆë‹¤)
          setInterval(() => this.loadEvents(), 60000 * 5);
          
          // ê²½ë¡œ ì •ë³´ ì—…ë°ì´íŠ¸ (5ë¶„ë§ˆë‹¤)
          setInterval(() => this.updateAllRoutes(), 60000 * 5);
  
          // ì¶œì„ ì •ë³´ ì—…ë°ì´íŠ¸ (1ë¶„ë§ˆë‹¤)
          setInterval(() => this.updateAttendance(), 60000);
        } else {
          this.showLoginScreen();
        }
      },
      
      /**
       * ë¡œê·¸ì¸
       */
      login: function(event) {
        event.preventDefault();
        
        const userIdInput = document.getElementById('userIdInput').value.trim();
        
        if (!userIdInput) {
          alert('ì‚¬ìš©ì IDë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
          return;
        }
        
        google.script.run
          .withSuccessHandler((user) => {
            if (user && user.userId) {
              this.userId = user.userId;
              this.userName = user.userName;
              
              localStorage.setItem('attendanceUserId', this.userId);
              localStorage.setItem('attendanceUserName', this.userName);
              
              this.showMainScreen();
              this.startLocationTracking();
              this.loadEvents();
              
              setInterval(() => this.updateLocation(), 60000);
              setInterval(() => this.loadEvents(), 60000 * 5);
              setInterval(() => this.updateAllRoutes(), 60000 * 5);
            } else {
              alert('âŒ ì‚¬ìš©ìë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
            }
          })
          .withFailureHandler((error) => {
            alert('âŒ ë¡œê·¸ì¸ ì‹¤íŒ¨\n\n' + error.message);
          })
          .getUserById(userIdInput);
      },
      
      /**
       * ë¡œê·¸ì•„ì›ƒ
       */
      logout: function() {
        if (confirm('ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
          if (this.watchId) {
            navigator.geolocation.clearWatch(this.watchId);
          }
          
          localStorage.removeItem('attendanceUserId');
          localStorage.removeItem('attendanceUserName');
          
          this.userId = null;
          this.userName = null;
          this.currentPosition = null;
          this.currentEvents = [];
          
          this.showLoginScreen();
        }
      },
      
      /**
       * ë¡œê·¸ì¸ í™”ë©´ í‘œì‹œ
       */
      showLoginScreen: function() {
        document.getElementById('loginContainer').style.display = 'flex';
        document.getElementById('mainContainer').style.display = 'none';
        document.getElementById('userIdInput').focus();
      },
      
      /**
       * ë©”ì¸ í™”ë©´ í‘œì‹œ
       */
      showMainScreen: function() {
        document.getElementById('loginContainer').style.display = 'none';
        document.getElementById('mainContainer').style.display = 'block';
        
        const userNameEl = document.getElementById('userName');
        if (userNameEl) {
          userNameEl.textContent = this.userName || this.userId;
        }
      },
      
      /**
       * ìœ„ì¹˜ ì¶”ì  ì‹œì‘
       */
      startLocationTracking: function() {
        if (!navigator.geolocation) {
          this.updateLocationStatus('error', 'âŒ ì´ ë¸Œë¼ìš°ì €ëŠ” ìœ„ì¹˜ ì„œë¹„ìŠ¤ë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
          return;
        }
        
        this.watchId = navigator.geolocation.watchPosition(
          (position) => {
            this.currentPosition = {
              lat: position.coords.latitude,
              lng: position.coords.longitude
            };
            
            const accuracy = Math.round(position.coords.accuracy);
            this.updateLocationStatus('active', `âœ… ìœ„ì¹˜ ì¶”ì  í™œì„±í™” (ì •í™•ë„: ${accuracy}m)`);
            
            this.updateLocation();
            
            // ìœ„ì¹˜ ë³€ê²½ ì‹œ ê²½ë¡œ ì •ë³´ë„ ì—…ë°ì´íŠ¸
            this.updateAllRoutes();
          },
          (error) => {
            this.updateLocationStatus('error', `âŒ ìœ„ì¹˜ ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ${error.message}`);
          },
          {
            enableHighAccuracy: true,
            timeout: 5000,
            maximumAge: 0
          }
        );
      },
  
      /**
       * ì¶œì„ ì •ë³´ ì—…ë°ì´íŠ¸
       */

      
      /**
       * ìœ„ì¹˜ ìƒíƒœ ì—…ë°ì´íŠ¸
       */
      updateLocationStatus: function(status, message) {
        const statusEl = document.getElementById('locationStatus');
        if (statusEl) {
          statusEl.className = `location-status ${status}`;
          statusEl.innerHTML = message;
        }
      },
      
      /**
       * ì„œë²„ì— ìœ„ì¹˜ ì—…ë°ì´íŠ¸
       */
      updateLocation: function() {
        if (!this.currentPosition || !this.userId) return;
        
        google.script.run
          .withSuccessHandler(() => {
            console.log('Location updated');
          })
          .withFailureHandler((error) => {
            console.error('Location update failed:', error);
          })
          .updateUserLocation({
            userId: this.userId,
            lat: this.currentPosition.lat,
            lng: this.currentPosition.lng
          });
      },
      
      /**
       * TMap APIë¡œ ê²½ë¡œ ì •ë³´ ê°€ì ¸ì˜¤ê¸° (ìºì‹± ì ìš©)
       */
      getTMapRoute: function(originLat, originLng, destLat, destLng, callback) {
        // ìºì‹œ í™•ì¸
        const cached = RouteCache.get(originLat, originLng, destLat, destLng);
        if (cached) {
          callback(cached);
          return;
        }

        // ìºì‹œê°€ ì—†ìœ¼ë©´ API í˜¸ì¶œ
        console.log('ğŸŒ TMap API í˜¸ì¶œ ì¤‘...');
        google.script.run
          .withSuccessHandler((result) => {
            if (result.success && result.routes) {
              // ìºì‹œì— ì €ì¥
              RouteCache.set(originLat, originLng, destLat, destLng, result.routes);
              callback(result.routes);
            } else {
              console.error('ê²½ë¡œ ì¡°íšŒ ì‹¤íŒ¨:', result.error);
              callback(null);
            }
          })
          .withFailureHandler((error) => {
            console.error('TMap API ì˜¤ë¥˜:', error);
            callback(null);
          })
          .getDetailedRoutes({
            originLat: originLat,
            originLng: originLng,
            destLat: destLat,
            destLng: destLng
          });
      },

      /**
       * ëª¨ë“  ì´ë²¤íŠ¸ì˜ ê²½ë¡œ ì •ë³´ ì—…ë°ì´íŠ¸
       */
      updateAllRoutes: function() {
        if (!this.currentPosition) {
          console.log('ê²½ë¡œ ì—…ë°ì´íŠ¸ ë¶ˆê°€: ìœ„ì¹˜ ì •ë³´ ì—†ìŒ');
          return;
        }

        // ì•„ì§ ì¶œë°œí•˜ì§€ ì•Šì€ ì´ë²¤íŠ¸ë“¤ë§Œ ì—…ë°ì´íŠ¸
        this.currentEvents.forEach(event => {
          if (!event.actualDepartureTime && event.destinationLat && event.destinationLng) {
            // TMap APIë¡œ ê²½ë¡œ ì •ë³´ ê°€ì ¸ì˜¤ê¸° (ìºì‹± ì ìš©)
            this.getTMapRoute(
              this.currentPosition.lat,
              this.currentPosition.lng,
              event.destinationLat,
              event.destinationLng,
              (routes) => {
                if (routes && routes.transit) {
                  console.log(`ì´ë²¤íŠ¸ ${event.eventId} ê²½ë¡œ ì •ë³´ ì—…ë°ì´íŠ¸ ì™„ë£Œ`);
                }
              }
            );
          }
        });
      },
      
      /**
       * ì´ë²¤íŠ¸ ëª©ë¡ ë¡œë“œ
       */
      loadEvents: function() {
        if (!this.userId) {
          console.log('âŒ userIdê°€ ì—†ìŠµë‹ˆë‹¤');
          return;
        }

        console.log('=== loadEvents ì‹œì‘ ===');
        console.log('userId:', this.userId);
        console.log('userId íƒ€ì…:', typeof this.userId);

        CommonUtils.showLoading('eventsList');

        console.log('ğŸ”µ getEventsByUser í˜¸ì¶œ ì‹œì‘...');

        google.script.run
          .withSuccessHandler((events) => {
            console.log('âœ… SUCCESS HANDLER í˜¸ì¶œë¨!');
            console.log('  - ìˆ˜ì‹  ë°ì´í„°:', events);
            console.log('  - ë°ì´í„° íƒ€ì…:', typeof events);
            console.log('  - null ì²´í¬:', events === null);
            console.log('  - undefined ì²´í¬:', events === undefined);
            console.log('  - Array ì²´í¬:', Array.isArray(events));
            console.log('  - ê°œìˆ˜:', events ? events.length : 'N/A');

            // null/undefined ë°©ì–´
            const safeEvents = events || [];
            console.log('âœ… ì•ˆì „í•œ ë°°ì—´ë¡œ ë³€í™˜:');
            console.log('  - ìµœì¢… ê°œìˆ˜:', safeEvents.length);
            console.log('  - ìµœì¢… íƒ€ì…:', typeof safeEvents);
            console.log('  - ìµœì¢… Array:', Array.isArray(safeEvents));

            if (safeEvents.length > 0) {
              console.log('  - ì²« ë²ˆì§¸ ì´ë²¤íŠ¸:', safeEvents[0]);
            } else {
              console.warn('âš ï¸ ì´ë²¤íŠ¸ ì—†ìŒ - Events ì‹œíŠ¸ë¥¼ í™•ì¸í•˜ì„¸ìš”');
            }

            this.currentEvents = safeEvents;
            this.displayEvents(safeEvents);

            // ë¡œë“œ í›„ ê²½ë¡œ ì •ë³´ ì—…ë°ì´íŠ¸
            setTimeout(() => this.updateAllRoutes(), 500);
          })
          .withFailureHandler((error) => {
            console.error('âŒ FAILURE HANDLER í˜¸ì¶œë¨!');
            console.error('  - ì—ëŸ¬ ê°ì²´:', error);
            console.error('  - ì—ëŸ¬ íƒ€ì…:', typeof error);
            console.error('  - ì—ëŸ¬ ë‚´ìš©:', error);

            // ì—ëŸ¬ ì‹œ ë¹ˆ ìƒíƒœ í‘œì‹œ
            this.currentEvents = [];
            this.displayEvents([]);
          })
          .getEventsByUser(this.userId);

        console.log('ğŸ”µ getEventsByUser í˜¸ì¶œ ì™„ë£Œ (ë¹„ë™ê¸°)');
      },
      
      /**
       * ì´ë²¤íŠ¸ í‘œì‹œ
       */
      displayEvents: function(events) {
        const container = document.getElementById('eventsList');
        
        if (!events || !Array.isArray(events) || events.length === 0) {
          container.innerHTML = `
            <div class="empty-state">
              <div class="empty-state-icon">ğŸ“…</div>
              <div class="empty-state-text">ë“±ë¡ëœ ì¼ì •ì´ ì—†ìŠµë‹ˆë‹¤</div>
              <div class="empty-state-subtext">Google Sheetsì˜ Events ì‹œíŠ¸ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”</div>
            </div>
          `;
          return;
        }
        
        const now = new Date();
        
        container.innerHTML = events.map(event => {
          const arrivalTime = new Date(event.arrivalTime);
          const isUpcoming = arrivalTime > now;
          const statusClass = CommonUtils.getStatusClass(event.attendanceStatus);
          const statusText = CommonUtils.getStatusText(event.attendanceStatus);
          const hasDeparted = event.actualDepartureTime;
          
          let cardClass = 'event-card';
          if (!event.prepStartTime) {
            cardClass += ' urgent';
          } else if (event.attendanceStatus === 'Present' || event.attendanceStatus === 'Late') {
            cardClass += ' completed';
          }
          
          return `
            <div class="${cardClass}" data-event-id="${event.eventId}">
              <div class="event-title">
                ${isUpcoming ? 'â°' : 'âœ“'} ${event.destination}
              </div>

              <div class="event-detail">
                <span class="label">ğŸ¯ ë„ì°© ì‹œê°„:</span>
                <span class="value" style="font-weight: 600; color: #dc3545;">${CommonUtils.formatDateTime(arrivalTime)}</span>
              </div>

              ${event.prepStartTime ? `
                <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 16px; border-radius: 12px; margin: 12px 0; color: white;">
                  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                    <div style="flex: 1;">
                      <div style="font-size: 12px; opacity: 0.9; margin-bottom: 4px;">â±ï¸ ì¤€ë¹„ ì‹œì‘</div>
                      <div style="font-size: 20px; font-weight: 700;">${CommonUtils.formatTime(event.prepStartTime)}</div>
                    </div>
                    <div style="width: 2px; height: 40px; background: rgba(255,255,255,0.3); margin: 0 16px;"></div>
                    <div style="flex: 1;">
                      <div style="font-size: 12px; opacity: 0.9; margin-bottom: 4px;">ğŸš— ì¶œë°œ ì˜ˆì •</div>
                      <div style="font-size: 20px; font-weight: 700;">${CommonUtils.formatTime(event.expectedDepartureTime)}</div>
                    </div>
                  </div>
                  <div style="display: flex; gap: 8px; font-size: 12px;">
                    <div style="flex: 1; background: rgba(255,255,255,0.2); padding: 8px; border-radius: 6px; text-align: center;">
                      <div style="opacity: 0.9;">ì¤€ë¹„ì‹œê°„</div>
                      <div style="font-weight: 600; margin-top: 2px;">${event.prepTime || 0}ë¶„</div>
                    </div>
                    <div style="flex: 1; background: rgba(255,255,255,0.2); padding: 8px; border-radius: 6px; text-align: center;">
                      <div style="opacity: 0.9;">ì´ë™ì‹œê°„</div>
                      <div style="font-weight: 600; margin-top: 2px;">${event.travelTime || 0}ë¶„</div>
                    </div>
                  </div>
                </div>

                <div class="timeline">
                  <div class="timeline-item">
                    <div class="timeline-icon ${new Date() >= new Date(event.prepStartTime) ? 'active' : ''}"></div>
                    <div class="timeline-text">ì¤€ë¹„ ì‹œì‘: ${CommonUtils.formatTime(event.prepStartTime)}</div>
                  </div>
                  <div class="timeline-item">
                    <div class="timeline-icon ${new Date() >= new Date(event.expectedDepartureTime) ? 'active' : ''}"></div>
                    <div class="timeline-text">ì¶œë°œ ì˜ˆì •: ${CommonUtils.formatTime(event.expectedDepartureTime)}</div>
                  </div>
                  <div class="timeline-item">
                    <div class="timeline-icon ${event.attendanceStatus === 'Present' || event.attendanceStatus === 'Late' ? 'active' : ''}"></div>
                    <div class="timeline-text">ë„ì°© ì˜ˆì •: ${CommonUtils.formatTime(event.arrivalTime)}</div>
                  </div>
                </div>
              ` : `
                <div style="background: #fff3cd; padding: 16px; border-radius: 12px; margin: 12px 0; border-left: 4px solid #ffc107;">
                  <div style="display: flex; align-items: center; gap: 12px;">
                    <div style="font-size: 32px;">âš ï¸</div>
                    <div>
                      <div style="font-weight: 600; color: #856404; margin-bottom: 4px;">ì¶œë°œì§€ ì •ë³´ê°€ í•„ìš”í•©ë‹ˆë‹¤</div>
                      <div style="font-size: 13px; color: #856404; opacity: 0.8;">ì¶œë°œì§€ì™€ ì¤€ë¹„ì‹œê°„ì„ ì…ë ¥í•˜ë©´ ì •í™•í•œ ì¤€ë¹„ì‹œì‘ ì‹œê°ê³¼ ì¶œë°œ ì˜ˆì • ì‹œê°ì„ ì•Œë ¤ë“œë¦½ë‹ˆë‹¤.</div>
                    </div>
                  </div>
                </div>
              `}

              <div class="event-detail" style="margin-top: 12px;">
                <span class="label">ì¶œì„ ìƒíƒœ:</span>
                <span class="status ${statusClass}">${statusText}</span>
              </div>

              <div class="event-actions">
                ${!event.prepStartTime ? `
                  <button onclick="UserApp.openEventModal('${event.eventId}', ${event.destinationLat}, ${event.destinationLng})" class="btn-primary full-width">
                    ğŸ“ ì¶œë°œì§€ ì •ë³´ ì…ë ¥
                  </button>
                ` : ''}
                <button onclick="UserApp.showRouteDetail('${event.eventId}', '${event.destination}', ${event.destinationLat}, ${event.destinationLng})" class="btn-secondary full-width" style="margin-top: 8px;">
                  ğŸ—ºï¸ ìƒì„¸ ê²½ë¡œ ë³´ê¸°
                </button>
              </div>
            </div>
          `;
        }).join('');
      },
      
      /**
       * ìƒì„¸ ê²½ë¡œ ëª¨ë‹¬ í‘œì‹œ - TMap API ì‚¬ìš©
       */
      showRouteDetail: function(eventId, destination, destLat, destLng) {
        if (!this.currentPosition) {
          alert('í˜„ì¬ ìœ„ì¹˜ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
          return;
        }
        
        // ëª¨ë‹¬ í‘œì‹œ
        const modal = document.getElementById('routeModal');
        const modalBody = document.getElementById('routeModalBody');
        
        if (!modal || !modalBody) return;
        
        // ë¡œë”© í‘œì‹œ
        modalBody.innerHTML = `
          <div style="padding: 40px; text-align: center;">
            <div style="font-size: 48px; margin-bottom: 16px; animation: spin 1s linear infinite;">ğŸ”„</div>
            <div style="font-size: 16px; color: #6c757d; margin-bottom: 8px;">TMapìœ¼ë¡œ ê²½ë¡œë¥¼ ì°¾ëŠ” ì¤‘...</div>
            <div style="font-size: 13px; color: #adb5bd;">ì‹¤ì‹œê°„ ëŒ€ì¤‘êµí†µ ì •ë³´ ì¡°íšŒ</div>
          </div>
          <style>
            @keyframes spin {
              from { transform: rotate(0deg); }
              to { transform: rotate(360deg); }
            }
          </style>
        `;
        modal.style.display = 'flex';
        
        // ì„œë²„ì—ì„œ TMap APIë¡œ ê²½ë¡œ ì¡°íšŒ
        google.script.run
          .withSuccessHandler((result) => {
            if (result.success) {
              this.displayRouteDetailModal(destination, result.routes);
            } else {
              this.displayRouteError(result.error);
            }
          })
          .withFailureHandler((error) => {
            this.displayRouteError(error.message);
          })
          .getDetailedRoutes({
            originLat: this.currentPosition.lat,
            originLng: this.currentPosition.lng,
            destLat: destLat,
            destLng: destLng,
            destination: destination
          });
      },
      
      /**
       * ìƒì„¸ ê²½ë¡œ ëª¨ë‹¬ ë‚´ìš© í‘œì‹œ
       */
      displayRouteDetailModal: function(destination, routes) {
        const now = new Date();
        const timeStr = `${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`;
        
        const modalBody = document.getElementById('routeModalBody');
        
        modalBody.innerHTML = `
          <div style="padding: 24px; max-height: 80vh; overflow-y: auto;">
            <!-- í—¤ë” -->
            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 16px;">
              <div style="flex: 1;">
                <h2 style="margin: 0 0 4px 0; font-size: 22px; font-weight: 700;">ğŸ—ºï¸ ${destination}</h2>
                <p style="margin: 0; color: #6c757d; font-size: 13px; line-height: 1.5;">
                  ${timeStr} ê¸°ì¤€ Â· í˜„ì¬ìœ„ì¹˜ â†’ ëª©ì ì§€
                </p>
              </div>
              <button onclick="UserApp.closeRouteModal()" style="background: #f8f9fa; border: none; width: 36px; height: 36px; border-radius: 50%; cursor: pointer; font-size: 20px; color: #6c757d; display: flex; align-items: center; justify-content: center; transition: all 0.2s; flex-shrink: 0; margin-left: 12px;">
                âœ•
              </button>
            </div>
            
            ${routes.transit?.isFallback ? `
              <div style="margin-bottom: 16px; padding: 12px; background: #fff3cd; border-radius: 8px; font-size: 13px; color: #856404;">
                âš ï¸ TMap API ì‘ë‹µì´ ì—†ì–´ ì˜ˆìƒ ê²½ë¡œë¥¼ í‘œì‹œí•©ë‹ˆë‹¤
              </div>
            ` : ''}
            
            <!-- ëŒ€ì¤‘êµí†µ ìƒì„¸ -->
            ${this.renderTransitDetail(routes.transit)}
            
            <!-- ìë™ì°¨ -->
            ${this.renderDriveDetail(routes.drive)}
            
            <!-- ë„ë³´ -->
            ${this.renderWalkDetail(routes.walk)}
            
            <!-- ì£¼ì˜ì‚¬í•­ -->
            <div style="margin-top: 20px; padding: 14px; background: #e3f2fd; border-radius: 8px; font-size: 13px; color: #1565c0; line-height: 1.6;">
              <div style="font-weight: 600; margin-bottom: 6px;">ğŸ’¡ ì•ˆë‚´</div>
              <ul style="margin: 0; padding-left: 20px;">
                <li>ì‹¤ì œ ì†Œìš”ì‹œê°„ì€ êµí†µ ìƒí™©ì— ë”°ë¼ ë‹¬ë¼ì§ˆ ìˆ˜ ìˆìŠµë‹ˆë‹¤</li>
                <li>ëŒ€ì¤‘êµí†µ ë°°ì°¨ ê°„ê²©ê³¼ í™˜ìŠ¹ ëŒ€ê¸°ì‹œê°„ì„ ê³ ë ¤í•˜ì„¸ìš”</li>
                <li>ì¶œë°œ ì „ ì‹¤ì‹œê°„ êµí†µì •ë³´ë¥¼ ë‹¤ì‹œ í™•ì¸í•˜ì„¸ìš”</li>
              </ul>
            </div>
            
            <!-- ë‹«ê¸° ë²„íŠ¼ -->
            <button onclick="UserApp.closeRouteModal()" class="btn-primary full-width" style="margin-top: 20px; padding: 14px;">
              í™•ì¸
            </button>
          </div>
        `;
      },
      
      /**
       * ëŒ€ì¤‘êµí†µ ìƒì„¸ ë Œë”ë§
       */
      renderTransitDetail: function(transit) {
        if (!transit) {
          return `
            <div style="padding: 20px; background: #f8f9fa; border-radius: 12px; margin-bottom: 16px; text-align: center; color: #6c757d;">
              ëŒ€ì¤‘êµí†µ ê²½ë¡œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤
            </div>
          `;
        }
        
        let stepsHtml = '';
        
        if (transit.steps && transit.steps.length > 0) {
          stepsHtml = transit.steps.map((step, index) => {
            return `
              <div style="display: flex; gap: 12px; margin-bottom: ${index < transit.steps.length - 1 ? '16px' : '0'};">
                <!-- ì•„ì´ì½˜ -->
                <div style="flex-shrink: 0; width: 44px; height: 44px; border-radius: 50%; background: ${step.color || '#667eea'}; display: flex; align-items: center; justify-content: center; font-size: 22px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                  ${step.icon}
                </div>
                
                <!-- ë‚´ìš© -->
                <div style="flex: 1;">
                  <div style="font-size: 15px; font-weight: 600; color: #2c3e50; margin-bottom: 4px;">
                    ${step.title}
                  </div>
                  <div style="font-size: 13px; color: #6c757d; line-height: 1.5;">
                    ${step.description}
                  </div>
                  ${step.duration ? `
                    <div style="display: inline-block; margin-top: 6px; padding: 4px 10px; background: #e3f2fd; border-radius: 12px; font-size: 12px; color: #1976d2; font-weight: 600;">
                      â±ï¸ ì•½ ${step.duration}ë¶„
                    </div>
                  ` : ''}
                </div>
              </div>
              
              ${index < transit.steps.length - 1 ? `
                <div style="margin-left: 22px; margin-bottom: 16px; border-left: 2px dashed #dee2e6; height: 24px;"></div>
              ` : ''}
            `;
          }).join('');
        }
        
        return `
          <div style="padding: 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 12px; color: white; margin-bottom: 16px; box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);">
            <!-- í—¤ë” -->
            <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 16px;">
              <div style="display: flex; align-items: center; gap: 12px;">
                <span style="font-size: 36px;">ğŸš‡</span>
                <div>
                  <div style="font-size: 20px; font-weight: 700;">ëŒ€ì¤‘êµí†µ</div>
                  <div style="font-size: 13px; opacity: 0.9;">ì§€í•˜ì²  Â· ë²„ìŠ¤</div>
                </div>
              </div>
              <div style="text-align: right;">
                <div style="font-size: 32px; font-weight: 700; line-height: 1;">${transit.duration}ë¶„</div>
                <div style="font-size: 13px; opacity: 0.9; margin-top: 4px;">${transit.distance}km</div>
              </div>
            </div>
            
            ${transit.fare ? `
              <div style="padding: 12px; background: rgba(255,255,255,0.2); border-radius: 8px; margin-bottom: 16px; font-size: 14px; display: flex; align-items: center; gap: 8px;">
                <span style="font-size: 20px;">ğŸ’³</span>
                <div>
                  <div style="font-size: 12px; opacity: 0.9;">êµí†µì¹´ë“œ ìš”ê¸ˆ</div>
                  <div style="font-size: 18px; font-weight: 700;">${transit.fare.toLocaleString()}ì›</div>
                </div>
              </div>
            ` : ''}
            
            ${transit.summary ? `
              <div style="padding: 10px; background: rgba(255,255,255,0.15); border-radius: 8px; margin-bottom: 16px; font-size: 12px; display: flex; justify-content: space-around;">
                <div>
                  <div style="opacity: 0.9;">ë„ë³´ ê±°ë¦¬</div>
                  <div style="font-weight: 600;">${Math.round(transit.summary.totalWalkDistance)}m</div>
                </div>
                <div>
                  <div style="opacity: 0.9;">ë„ë³´ ì‹œê°„</div>
                  <div style="font-weight: 600;">${transit.summary.totalWalkTime}ë¶„</div>
                </div>
              </div>
            ` : ''}
            
            <!-- ìƒì„¸ ê²½ë¡œ -->
            <div style="background: white; padding: 18px; border-radius: 10px; color: #2c3e50;">
              ${stepsHtml}
            </div>
          </div>
        `;
      },
      
      /**
       * ìë™ì°¨ ìƒì„¸ ë Œë”ë§
       */
      renderDriveDetail: function(drive) {
        if (!drive) return '';
        
        return `
          <div style="padding: 20px; background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); border-radius: 12px; color: white; margin-bottom: 16px; box-shadow: 0 4px 12px rgba(240, 147, 251, 0.3);">
            <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 16px;">
              <div style="display: flex; align-items: center; gap: 12px;">
                <span style="font-size: 36px;">ğŸš—</span>
                <div>
                  <div style="font-size: 20px; font-weight: 700;">ìë™ì°¨</div>
                  <div style="font-size: 13px; opacity: 0.9;">íƒì‹œ Â· ìŠ¹ìš©ì°¨</div>
                </div>
              </div>
              <div style="text-align: right;">
                <div style="font-size: 32px; font-weight: 700; line-height: 1;">${drive.duration}ë¶„</div>
                <div style="font-size: 13px; opacity: 0.9; margin-top: 4px;">${drive.distance}km</div>
              </div>
            </div>
            
            ${drive.taxiFare ? `
              <div style="background: rgba(255,255,255,0.2); border-radius: 8px; padding: 14px;">
                <div style="font-size: 14px; display: flex; justify-content: space-between; align-items: center; margin-bottom: ${drive.tollFare > 0 ? '10px' : '0'};">
                  <span style="display: flex; align-items: center; gap: 8px;">
                    <span style="font-size: 20px;">ğŸš•</span>
                    <span>ì˜ˆìƒ íƒì‹œë¹„</span>
                  </span>
                  <strong style="font-size: 18px;">${drive.taxiFare.toLocaleString()}ì›</strong>
                </div>
                ${drive.tollFare && drive.tollFare > 0 ? `
                  <div style="font-size: 13px; display: flex; justify-content: space-between; opacity: 0.9; padding-top: 10px; border-top: 1px solid rgba(255,255,255,0.3);">
                    <span>+ í†µí–‰ë£Œ</span>
                    <span>${drive.tollFare.toLocaleString()}ì›</span>
                  </div>
                ` : ''}
              </div>
            ` : ''}
          </div>
        `;
      },
      
      /**
       * ë„ë³´ ìƒì„¸ ë Œë”ë§
       */
      renderWalkDetail: function(walk) {
        if (!walk) return '';
        
        return `
          <div style="padding: 20px; background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); border-radius: 12px; color: white; margin-bottom: 16px; box-shadow: 0 4px 12px rgba(79, 172, 254, 0.3);">
            <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 16px;">
              <div style="display: flex; align-items: center; gap: 12px;">
                <span style="font-size: 36px;">ğŸš¶</span>
                <div>
                  <div style="font-size: 20px; font-weight: 700;">ë„ë³´</div>
                  <div style="font-size: 13px; opacity: 0.9;">ê±¸ì–´ì„œ ì´ë™</div>
                </div>
              </div>
              <div style="text-align: right;">
                <div style="font-size: 32px; font-weight: 700; line-height: 1;">${walk.duration}ë¶„</div>
                <div style="font-size: 13px; opacity: 0.9; margin-top: 4px;">${walk.distance}km</div>
              </div>
            </div>
          </div>
        `;
      },
      
      /**
       * ê²½ë¡œ ì—ëŸ¬ í‘œì‹œ
       */
      displayRouteError: function(errorMessage) {
        const modalBody = document.getElementById('routeModalBody');
        
        modalBody.innerHTML = `
          <div style="padding: 40px; text-align: center;">
            <div style="font-size: 64px; margin-bottom: 16px;">âš ï¸</div>
            <h3 style="margin: 0 0 8px 0; font-size: 18px; color: #dc3545;">ê²½ë¡œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤</h3>
            <p style="margin: 0 0 24px 0; color: #6c757d; font-size: 14px;">${errorMessage}</p>
            <button onclick="UserApp.closeRouteModal()" class="btn-primary">
              í™•ì¸
            </button>
          </div>
        `;
      },
      
      /**
       * ê²½ë¡œ ëª¨ë‹¬ ë‹«ê¸°
       */
      closeRouteModal: function() {
        const modal = document.getElementById('routeModal');
        if (modal) {
          modal.style.display = 'none';
        }
      },
      
      /**
       * ì´ë²¤íŠ¸ ëª¨ë‹¬ ì—´ê¸°
       */
      openEventModal: function(eventId, destLat, destLng) {
        const eventIdEl = document.getElementById('eventId');
        const destLatEl = document.getElementById('destinationLat');
        const destLngEl = document.getElementById('destinationLng');
        const modalEl = document.getElementById('eventModal');
        const routeInfoEl = document.getElementById('routeInfo');

        if (eventIdEl) eventIdEl.value = eventId;
        if (destLatEl) destLatEl.value = destLat;
        if (destLngEl) destLngEl.value = destLng;
        if (modalEl) modalEl.style.display = 'flex';
        if (routeInfoEl) routeInfoEl.style.display = 'none';
      },
      
      /**
       * ëª¨ë‹¬ ë‹«ê¸°
       */
      closeModal: function() {
        const modalEl = document.getElementById('eventModal');
        const formEl = document.getElementById('eventForm');
        const errorEl = document.getElementById('formError');
        const routeInfoEl = document.getElementById('routeInfo');

        if (modalEl) modalEl.style.display = 'none';
        if (formEl) formEl.reset();
        if (errorEl) errorEl.textContent = '';
        if (routeInfoEl) routeInfoEl.style.display = 'none';
      },
      
      /**
       * í˜„ì¬ ìœ„ì¹˜ ì‚¬ìš©
       */
      useCurrentLocation: function() {
        if (!this.currentPosition) {
          CommonUtils.showErrorAlert('í˜„ì¬ ìœ„ì¹˜ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ìœ„ì¹˜ ì„œë¹„ìŠ¤ë¥¼ í™œì„±í™”í•´ì£¼ì„¸ìš”.');
          return;
        }
        
        document.getElementById('departureLat').value = this.currentPosition.lat;
        document.getElementById('departureLng').value = this.currentPosition.lng;
        document.getElementById('departureLocation').value = 'í˜„ì¬ ìœ„ì¹˜';
        
        CommonUtils.showSuccess('í˜„ì¬ ìœ„ì¹˜ê°€ ì„¤ì •ë˜ì—ˆìŠµë‹ˆë‹¤.');
      },
      
      
      /**
       * ì´ë²¤íŠ¸ ìƒì„¸ ì •ë³´ ì œì¶œ
       */
      submitEventDetails: function(event) {
        event.preventDefault();

        const eventId = document.getElementById('eventId').value;
        const departureLocation = document.getElementById('departureLocation').value;
        const prepTime = parseInt(document.getElementById('prepTime').value);
        const departureLat = document.getElementById('departureLat').value;
        const departureLng = document.getElementById('departureLng').value;
        const destLat = document.getElementById('destinationLat').value;
        const destLng = document.getElementById('destinationLng').value;

        if (!departureLat || !departureLng) {
          CommonUtils.showError('formError', 'ì¶œë°œì§€ ìœ„ì¹˜ë¥¼ ì„¤ì •í•´ì£¼ì„¸ìš”.');
          return;
        }

        const submitBtn = event.target.querySelector('button[type="submit"]');
        const originalText = submitBtn.textContent;
        submitBtn.textContent = 'ê²½ë¡œ ì¡°íšŒ ì¤‘...';
        submitBtn.disabled = true;

        // TMap APIë¡œ ì‹¤ì œ ì´ë™ì‹œê°„ ê³„ì‚° (ìºì‹± ì ìš©)
        this.getTMapRoute(
          parseFloat(departureLat),
          parseFloat(departureLng),
          parseFloat(destLat),
          parseFloat(destLng),
          (routes) => {
            let estimatedTime = 30; // ê¸°ë³¸ê°’

            if (routes && routes.transit && routes.transit.duration) {
              estimatedTime = routes.transit.duration;
              console.log('âœ… TMap API ì´ë™ì‹œê°„:', estimatedTime, 'ë¶„');
            } else {
              console.log('âš ï¸ TMap API ì‹¤íŒ¨, ê¸°ë³¸ê°’ ì‚¬ìš©:', estimatedTime, 'ë¶„');
            }

            submitBtn.textContent = 'ì €ì¥ ì¤‘...';

            google.script.run
              .withSuccessHandler((result) => {
                submitBtn.textContent = originalText;
                submitBtn.disabled = false;

                if (result.success) {
                  const message = `ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!\n\n` +
                                `ì˜ˆìƒ ì´ë™ì‹œê°„: ${result.travelTime}ë¶„\n` +
                                `ì¶œë°œ ì˜ˆì •: ${CommonUtils.formatDateTime(result.expectedDepartureTime)}\n` +
                                `ì¤€ë¹„ ì‹œì‘: ${CommonUtils.formatDateTime(result.prepStartTime)}`;

                  alert(message);
                  this.closeModal();
                  this.loadEvents();
                } else {
                  CommonUtils.showError('formError', 'ì €ì¥ ì‹¤íŒ¨: ' + result.error);
                }
              })
              .withFailureHandler((error) => {
                submitBtn.textContent = originalText;
                submitBtn.disabled = false;
                CommonUtils.showError('formError', 'ì €ì¥ ì‹¤íŒ¨: ' + error);
              })
              .updateEventDetails({
                eventId: eventId,
                departureLocation: departureLocation,
                departureLat: parseFloat(departureLat),
                departureLng: parseFloat(departureLng),
                prepTime: prepTime,
                estimatedTravelTime: estimatedTime
              });
          }
        );
      }
    };
    
    // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
    window.onload = function() {
      UserApp.init();
    };
  </script>